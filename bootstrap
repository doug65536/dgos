#!/bin/bash

scriptroot="$(cd "$(dirname "$0")" && pwd)"

. "$scriptroot/toolchain/build-crossgcc-versions"

printf "Using gcc version: %s\n" "$gccver"

if [[ -z $TARGET ]]; then
	TARGET=x86_64-dgos
	echo TARGET not in environment, assumed $TARGET
fi

NPROC="$(nproc)"

function help() {
	:
}

lto=
optimized=
cleanbuild=
quiet=
while getopts colh?qj arg
do
	case $arg in
		c ) cleanbuild=1 ; shift ;;
		o ) optimized=1 ; shift ;;
		l ) lto=1 ; shift ;;
		q ) quiet=1 ; shift ;;
		h ) help && exit ;;
		? ) help && exit ;;
		* ) echo "unrecognized option '$arg'" ; exit 1 ;;
	esac
done

toolchain_build_dir=toolchain_build
toolchain_install_dir=toolchain_install

if ! [[ -z $cleanbuild ]]; then
	echo "Cleaning toolchain_build/build" \
		" $toolchain_build_dir/src $toolchain_install_dir..."
	rm -rf "$toolchain_build_dir/build" "$toolchain_build_dir/src" \
		"$toolchain_build_dir/build.log" "$toolchain_install_dir" || exit
fi

if ! which $TARGET-g++ || [[ ! -f toolchain_install/bin/$TARGET-g++ ]]; then
	time AR=gcc-ar RANLIB=gcc-ranlib \
		"$scriptroot/toolchain/build-crossgcc.bash" -a "$TARGET" \
		-o toolchain_build \
		-p toolchain_install -q || exit
	printf "Toolchain built successfully\n"
fi

printf '# Run this command in a shell to use this: . ./set_toolchain_path\n' \
	| tee "$toolchain_install_dir/set_toolchain_path" || exit

rm -f set_toolchain_path || exit
ln -rs "$toolchain_install_dir/set_toolchain_path" set_toolchain_path || exit

printf 'export PATH="%s/toolchain_install/bin:$PATH"\n' "$PWD" \
	| tee -a set_toolchain_path || exit

toolchain_stdlib=$([[ -d $toolchain_install_dir ]] &&
	find "$toolchain_install_dir" -type f -name stdbool.h |
	grep -v freestand)

toolchain_ldscripts=$([[ -d $toolchain_install_dir ]] &&
	find "$toolchain_install_dir" -type d -name ldscripts)

toolchain_include_dir=${toolchain_stdlib%/*}
toolchain_lib_dir=${toolchain_ldscripts%/*}

if [[ -z $toolchain_install_dir ]]; then
	printf "No toolchain install dir\n"
	exit 1
fi
if [[ -z $toolchain_include_dir ]]; then
	printf "No toolchain include dir\n"
	exit 1
fi
if [[ -z $toolchain_lib_dir ]]; then
	printf "No toolchain lib dir\n"
	exit 1
fi

printf "#This is automatically generated by bootstrap\n" > toolchain_config.mk
printf "TOOLCHAIN_DIR=$PWD/%s\n" "$toolchain_install_dir" \
	>> toolchain_config.mk
printf "TOOLCHAIN_INCLUDE_PATH=$PWD/%s\n" "$toolchain_include_dir" \
	>> toolchain_config.mk
printf "TOOLCHAIN_LIB_PATH=$PWD/%s\n" "$toolchain_lib_dir" \
	>> toolchain_config.mk

export PATH="$PATH"":""$PWD/toolchain_install/bin"
printf "PATH=%s\n" "$PATH"

function join_by {
	local IFS="$1"
	shift
	printf "%s" "$*"
}

export AR="$TARGET-gcc-ar"
export RANLIB="$TARGET-gcc-ranlib"
export NM="$TARGET-gcc-nm"

(cd -- "$scriptroot" &&
	autoreconf -f &&
	git submodule update --init) || exit

echo Bootstrapping sysroot
compileflags=( "-nostdlib" "-nostartfiles" )
configureflags=()
if [[ -n $lto ]]; then
	echo "Enabling LTO"
	configureflags+=("--enable-optimize")
	configureflags+=("--enable-lto")
elif [[ -n $optimized ]]; then
	echo "Enabling optimized"
	configureflags+=("--enable-optimize")
fi

rm -rf sysroot || exit

"$scriptroot/configure" --host "$TARGET" \
	CFLAGS="$(join_by ' ' ${compileflags[@]})" \
		CXXFLAGS="$CFLAGS" \
		LDFLAGS="$CFLAGS" \
	$(join_by ' ' ${configureflags[@]}) "$@" && \
	make -j "$NPROC" \
		sysroot/lib/crt0.o \
		sysroot/lib/32/crt0.o \
		sysroot/lib/crt0pc32.o \
		sysroot/lib/32/crt0pc32.o \
		sysroot/lib/crt0pc64.o \
		sysroot/lib/32/crt0pc64.o \
		sysroot/lib/crt0pc80.o \
		sysroot/lib/32/crt0pc80.o \
		sysroot/lib/libc.a \
		sysroot/lib/32/libc.a \
		sysroot/lib/libm.a \
		sysroot/lib/32/libm.a \
		sysroot/lib/libstdc++.a \
		sysroot/lib/32/libstdc++.a \
		startupcode

if [[ -d sysroot/include ]]; then
	echo Copying include files to toolchain install
	cp -R -u -t "toolchain_install/lib/gcc/$TARGET/$gccver/include" \
		sysroot/include/* && \
		echo Successfully copied include files || exit
fi

if [[ -d sysroot/lib ]]; then
	echo Copying lib files to toolchain install
	cp -R -u -t "toolchain_install/lib/gcc/$TARGET/$gccver/" \
		sysroot/lib/* && \
		echo Successfully copied lib files || exit
fi

make -j "$NPROC" usrlib_headers || exit

echo Copying include files to toolchain install
cp -R -u -t "toolchain_install/lib/gcc/$TARGET/$gccver/include" \
	sysroot/include/* && \
	echo Successfully copied include files || exit

echo Copying lib files to toolchain install
cp -R -u -t "toolchain_install/lib/gcc/$TARGET/$gccver/" \
	sysroot/lib/* && \
	echo Successfully copied lib files || exit

compileflags=( "--sysroot sysroot" )
configureflags=()

echo flags: "${compileflags[@]}"

CFLAGS="$(join_by ' ' ${compileflags[@]})" \
	CXXFLAGS="$CFLAGS" \
	LDFLAGS="$CFLAGS" \
	"$scriptroot/configure" --host "$TARGET" \
	$(join_by ' ' "${configureflags[@]}") "$@" || exit

echo Completed successfully
